## TCP/IP协议

### TCP的连接与三次握手
TCP作为一种可靠传输协议，既要保证数据可靠传输，又要提高传输的效率。TCP的可靠传输协议是靠seq完成的，简历一个可靠的单向通道需要至少一次SYN和ACK完成seq的确定，并且在今后的通讯中依靠ACK seq(+1)确保发送成功。
首先TCP连接的发起方由操作系统随机生成32位的序列号即seq。(seq是数据包本身的序列号；ack是期望对方继续发送的那个数据包的序列号)
TCP建立连接的过程为：
1. A发送同步信号SYN+A的初始化seq
2. B收到A的同步信号，并记录到A的seq到本地，命名为B的ACK seq
3. B发送同步信号SYN+B的初始化seq
4. A收到B的同步信号，并记录到B的seq到本地，命名为A的ACK seq(发送完后A进入Established的状态)
其中2和3可以合并，所以只需要三次握手就可以完成一次通信连接，其中三次是保证双方互相明确对方能收能发的最低值。


#### 扩展
第一个包，即A发给B的SYN 中途被丢，没有到达B
A会周期性超时重传，直到收到B的确认
第二个包，即B发给A的SYN +ACK 中途被丢，没有到达A
B会周期性超时重传，直到收到A的确认
第三个包，即A发给B的ACK 中途被丢，没有到达B
由上图所知，此时A已经进入Established状态，但是B由于没有收到A的请求，所以会一直处于等待的状态。

#### 为什么不采用两次握手
如果A向B发送的连接请求丢失，A在等待应达超时后会再次发送，此时，上一个连接请求就是失效的。
若建立连接只需两次握手，客户端并没有太大的变化，仍然需要获得服务端的应答后才进入ESTABLISHED状态，而服务端在收到连接请求后就进入ESTABLISHED状态。此时如果网络拥塞，客户端发送的连接请求迟迟到不了服务端，客户端便超时重发请求，如果服务端正确接收并确认应答，双方便开始通信，通信结束后释放连接。此时，如果那个失效的连接请求抵达了服务端，由于只有两次握手，服务端收到请求就会进入ESTABLISHED状态，等待发送数据或主动发送数据。但此时的客户端早已进入CLOSED状态，服务端将会一直等待下去，这样浪费服务端连接资源。


### TCP的断开与四次挥手
TCP连接是双向的，因此在四次挥手中，前两次挥手用于断开一个方向的连接，后两次挥手用于断开另一方向的连接。

1. A认为数据已经发送完，向B发送FIN = 1和seq=u，请求释放连接。
2. B收到请求，向A发送释放连接的应答，ACK=1，seq=v，ack=u+1
3. B发送完数据后，向A发送请求释放连接，FIN=1，ACK=1，seq=w
4. A收到请求，向B发送释放连接的应答，在一段时间内(2MSL)A进入CLOSED状态，B在收到ACK后也进入CLOSED状态，连接彻底终止。

####  为什么A要先进入TIME-WAIT状态，等待2MSL时间后才进入CLOSED状态？
为了保证B能收到A的确认应答。 
若A发完确认应答后直接进入CLOSED状态，那么如果该应答丢失，B等待超时后就会重新发送连接释放请求，但此时A已经关闭了，不会作出任何响应，因此B永远无法正常关闭。


### TCP可靠传输的实现
1. 以字节为单位的滑动窗口
TCP通过滑动窗口机制检测丢包，并在丢包发生时调整数据传输速率。滑动窗口机制利用数据接收端的接收窗口来控制数据流。接收窗口值由数据接收端指定，以字节数形式存储于TCP报文头，并告知传输设备有多少数据将会存储在TCP缓冲区。缓冲区就是数据暂时放置的地方，直至传递至应用层协议等待处理。因此，发送端每次只能发送Window Size字段指定的数据量。为了使发送端继续传送数据，接收端必须发送确认信息：之前的数据接收到了。如果出现丢失，会启用重传机制

2. 超时重传
TCP的发送方在规定的时间内没有收到确认就要重试已发送的报文字段。在发送一个数据之后，就开启一个定时器，若是在这个时间内没有收到发送数据的ACK确认报文，则对该报文进行重传，在达到一定次数还没有成功时放弃并发送一个复位信号。 这里比较重要的是重传超时时间，怎样设置这个定时器的时间（RTO），从而保证对网络资源最小的浪费。因为若RTO太小，可能有些报文只是遇到拥堵或网络不好延迟较大而已，这样就会造成不必要的重传。太大的话，使发送端需要等待过长的时间才能发现数据丢失，影响网络传输效率。 
由于不同的网络情况不一样，不可能设置一样的RTO，实际中RTO是根据网络中的RTT（传输往返时间）来自适应调整的。
重传是重传整个报文段，如果只是部分数据丢失可以采用下面的方式。
3. 选择确认
如果收到的报文段没有问题，只是未按照序号，中间缺少了一些序号的数据，可以通过选择确认只重传缺少的数据。但是实际使用中还是重传所有未被确认的数据块。

### TCP流量控制
TCP是传输控制协议，可以利用滑动窗口实现流量控制。
流量控制就是让发送方的发送速率不要太快，要让接受方来得及进行接受。发送方的发送窗口不能超过接收方给出的接受窗口的数值，注意窗口的单位是字节不是报文段。

### TCP拥塞控制
拥塞控制就是防止过多的数据注入到网络中，这样可以使网络中的路由器或链路不致过载，使得网络可以承载现有的网络负荷。主要有四种进行拥塞控制的算法：
1. 慢开始：由小到大逐渐增加拥塞窗口的数值
2. 拥塞避免：让拥塞窗口缓慢增大
3. 快重传
4. 快恢复







