## 数据库的事务
### 什么是事务
1. 事务是数据库系统区别于其他一切文件系统的重要特性之一
2. 事务是一组具有原子性的SQL语句，或是一个独立的工作单元(要么全部成功，要么全部失败)
3. 事务需要满足原子性、一致性、隔离性、持久性

#### 原子性
一个事务必须被视为一个不可分割的最小工作单元，整个事务中的所有操作要么全部提交成功，
要么全部回滚失败，对于一个事务来说，不可能只执行其中一部分操作

#### 一致性
一致性是指事务将数据库从一种一致性状态转换到另外一种一致性状态，在事务开始之前和
事务结束之后数据库中数据的完整性没有破坏

#### 隔离性
隔离性要求一个事务对数据库中数据的修改，在未提交完成前对于其他事务是不可见的
SQL标准中定义了四种隔离级别, 隔离性由低到高，并发性由高到低
* 未提交读(READ UNCOMMITED)
* 已提交读(READ COMMITED)
* 可重复读(REPEATABLE READ)
* 可串行化(SERIALIZABLE) 

#### 持久性
一旦事务提交，则其所做的修改就会永远保存在数据库中。此时即使系统崩溃，
已经提交的修改数据也不会丢失。

### 什么是大事务
#### 定义
运行时间比较长，操作的数据比较多的事务

#### 风险
* 锁定太多的数据，造成大量的阻塞和锁超时
* 回滚时所需时间比较长
* 执行时间长，容易造成主从延迟

#### 如何处理大事务
* 避免一次处理太多的数据
* 移出不必要在事务中的SELECT操作

### MySQL的事务
Mysql 的事务的隔离级别是以锁进行实现的，InnoDB 引擎是基于 MVCC (Multi-Versioning
Concurrency Control)和锁的复合实现的。隔离程度从高到低分为四个层次：
1. 读未提交(Read uncommitted)，指一个事务可以看到其他事务尚未提交的修改，这是最
低级的隔离级别，可以允许脏读出现；
2. 读已提交(Read committed)，事务能够看到的数据都是其他事务已经提交的修改，也就是保证
不会看到中间性状态，不会出现脏读，但是不能保证再次读取时能够出现同样的数据，也就是允许
其他事务并发修改数据，允许出现不可重复读和幻读；
3. 可重复读(Repeatable reads)，保证同一个事务中多次读到的数据是一致的，Mysql 的
默认隔离级别，MySQL中可重复读这一级别已经解决了不可重复读和幻读的问题，主要是通过MVCC
实现的，其他数据库在这一级别是无法解决幻读问题的；
4. 串行化(Serializable)，并发事务是串行化的，读取需要获取共享锁，更新需要排他锁，使用
where 语句还需要区间锁，是MySQL的最高级别。

#### 悲观锁和乐观锁
在并发场景下需要对共享数据进行加锁，防止产生数据冲突。
* 乐观锁：认为大部分情况下不会产生数据冲突，不会直接进行加锁，而是通过对比数据的时间戳
或者版本号，来实现乐观锁需要的版本判断，只有在实际遇到冲突时才会进行排他锁的实现措施；
* 悲观锁：认为数据冲突的可能性很大，会直接对共享数据进行排他性处理。