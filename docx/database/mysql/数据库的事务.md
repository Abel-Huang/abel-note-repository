# 数据库的事务
## 什么是事务
1. 事务是数据库系统区别于其他一切文件系统的重要特性之一
2. 事务是一组具有原子性的SQL语句，或是一个独立的工作单元(要么全部成功，要么全部失败)
3. 事务需要满足原子性、一致性、隔离性、持久性


### 原子性
一个事务必须被视为一个不可分割的最小工作单元，整个事务中的所有操作要么全部提交成功，
要么全部回滚失败，对于一个事务来说，不可能只执行其中一部分操作
### 一致性
一致性是指事务将数据库从一种一致性状态转换到另外一种一致性状态，在事务开始之前和
事务结束之后数据库中数据的完整性没有破坏
### 隔离性
隔离性要求一个事务对数据库中数据的修改，在未提交完成前对于其他事务是不可见的
SQL标准中定义了四种隔离级别, 隔离性由低到高，并发性由高到低
* 未提交读(READ UNCOMMITED)
* 已提交读(READ COMMITED)
* 可重复读(REPEATABLE READ)
* 可串行化(SERIALIZABLE) 
### 持久性
一旦事务提交，则其所做的修改就会永远保存在数据库中。此时即使系统崩溃，
已经提交的修改数据也不会丢失。

## MySQL 事务实现原理
事务的实现是基于数据库的存储引擎，不同的存储引擎对事务的支持程度不同，MySQL中支持事务的存储引擎有 InnoDB 和 NDB。对于 MySQL 而言，事务的隔离性是通过锁，MVCC 来实现的，而事务的原子性，一致性和持久性则是通过事务日志实现的。

### 事务日志
事务日志可以帮助提高事务效率：
* 使用事务日志，存储引擎在修改表的数据时只需要修改内存拷贝，再将修改行为记录到持久在硬盘上的事务日志上，而不是每次都将修改的数据本身持久到硬盘；
* 事务日志采用的是追加的方式，写日志操作是磁盘一小块区域内的顺序 IO，因此事务方式的 IO 速度要快得多；
* 如果数据的修改已经记录到事务日志并持久化，即使数据本身没有写回到磁盘，这时系统崩溃，存储引擎在重启时也能够自动恢复这一部分修改的数据。
* 目前大多数存储引擎都是这样实现的，通常称为预写式日志(Write-Ahead-Logging)，修改数据需要写两次磁盘。
* MySQL 最主要的事务日志就是 redo 和 undo, 其中 redo log 称为重做日志，用来保证事务的原子性和持久性，undo log 用来保证事务的一致性。redo 是物理日志，而 undo 是逻辑日志。

#### redo log
事务开启时，事务中的操作都会先写入存储引擎的日志缓冲中，在事务提交之前，这些缓冲的日志都需要提前刷新到磁盘上持久化；事务提交后， 在 Buffer Pool 中映射的数据文件才会慢慢刷新到磁盘，如果此时数据库崩溃或者宕机，那么当系统进行恢复时，就可以根据 redo log 中记录的日志，把数据库恢复到崩溃前的一个状态。未完成的事务可以继续提交，也可以选择回滚，这取决于恢复的策略而定。

#### undo log
undo log 主要为事务的回滚服务。执行过程中，除了记录 redo log，还会记录一定量的 undo log。undo
log 记录了数据在每个操作前的状态，如果事务执行过程中需要回滚，那么就可以根据 undo log 进行回滚操作。单个事务的回滚，只会回滚当前事务的操作，不会影响到其他的事务的操作。

#### MySQL 中事务的使用
MySQL 的服务层不管理事务，而是由下层的存储引擎实现。
1. MySQL 支持本地事务的语句
```sql
START TRANSACTION | BEGIN % 开启新的事务
COMMIT  % 提交事务
ROLLBACK % 回滚事务
SET AUTOCOMMIT 
```
2. 注意
    * 如果在锁表阶段，使用 start transaction 命令开始一个事务，会造成一个隐含的 unlock tables 被执行；
    * 在同一个事务中，最好不使用不同存储引擎的表，否则 ROLLBACK 时需要对非事务类型的表进行
   特别处理，因为 COMMIT，ROLLBACK 只能对事务类型的表进行提交和回滚。
   * 所有的 DDL 语句不能回滚；
3. MySQL 默认采用自动提交模式。

#### MySQL 对分布式事务的支持
InnoDB 提供对分布式事务的支持。一个分布式事务会涉及多个行为，这些行为本身是事务的，所有的行为必须保证一起成功完成，或者一起被回滚。

## 什么是大事务
### 定义
运行时间比较长，操作的数据比较多的事务

### 风险
* 锁定太多的数据，造成大量的阻塞和锁超时
* 回滚时所需时间比较长
* 执行时间长，容易造成主从延迟

### 如何处理大事务
* 避免一次处理太多的数据
* 移出不必要在事务中的SELECT操作