## SQL查询优化
### 获取有性能问题的SQL
1. 通过用户反馈(包括测试人员)存在性能问题的SQL(不推荐)
2. 通过慢查询日志获取性能问题的SQL(存储引擎无关)
3. 实时获取性能问题的SQL

### 慢查询日志
慢查询日志的性能开销比较低，主要的性能问题来自于磁盘IO和存储日志所需要的磁盘空间。
慢查询日志会记录所有符合条件的SQL，包括查询语句，数据修改语句和已经回滚的SQL。

#### 慢查询日志的配置
`slow_query_log='ON'` 通过动态参数开启和关闭慢查询日志   
`slow_query_log_file` 指定慢查询日志的存储路径及文件
`long_query_time` 指定慢查询日志SQL执行时间的阈值(默认10s，改成0.001s比较合适)
`log_queries_not_using_indexes`是否记录未使用索引的SQL

#### 慢查询日志的分析工具
mysqldumpslow 官方提供的慢查询日志

pt-query-digest 慢查询分析工具,第三方提供

### 实时获取有性能问题的SQL
information_schema数据库中的PROCESSLIST表

### SQL解析处理及生成执行计划
#### SQL执行的流程
1. 客户端发送SQL请求给服务器()
2. 服务器检查是否可以在查询缓存中命中该SQL
3. 服务器端进行SQL解析，预处理，再由优化器生成对应的执行计划
4. 根据执行计划，调用存储引擎API来查询数据
5. 将结果返回给客户端

#### 查询缓存对SQL性能的影响
1. 优先检查这个查询是否命中查询缓存中的数据，通过一个大小写敏感的Hash匹配，只能通过全值匹配。
然后会检查用户的权限。
2. 对于一个读写频繁的系统使用查询缓存可能会降低查询处理的效率，这种场景不要使用查询缓存

#### SQL执行计划和存储引擎
包括多个子过程：
解析SQL，预处理，优化SQL执行计划
1. 语法解析阶段是通过关键字对MySQL语句进行解析，并且生成一棵对应的语法树
    * 在解析过程中出现解析错误就会终止这个过程
2. 查询优化器会根据统计信息和设置的索引生成最优的查询执行计划
3. 造成MySQL生成错误的执行计划的原因
    * 统计信息不准确
    * 执行计划中的成本估算不等同于实际的执行计划的成本
    * MySQL优化器所认为的最优可能与所需求的最优不一致
    * MysQL不考虑其他并发的查询，这可能会影响当前的查询速度
    * MySQL有时候也会根据一些固定的规则来生成执行计划
    * MySQL不会考虑其不受控制的成本(如存储过程、函数)
4. MySQL可以优化的SQL类型
    * 重新定义表的关联顺序
    * 将外链接转化为内连接
    * 使用等价变换规则
    * 优化count(),min(),max()等函数
    * 将一个表达式转化为一个常数表达式
    * 子查询优化(如将子查询转为关联查询)
    * 提前终止查询
    * 对in()条件进行优化
    
### MySQL在各个阶段消耗的时间
1. 使用profile
session级别的处理，已经不推荐使用
2. performance_schema 
推荐使用

### 特定场景下的SQL优化策略
1. 大表的数据修改最好分批处理

2. 修改大表的表结构
在主服务器上新表，将旧表数据迁移到新表

3.优化not in和<>查询
使用join对not in进行优化

4. 使用汇总表优化查询
汇总表就是提前以要统计的数据进行汇总并记录到表中，已被后续的查询使用
